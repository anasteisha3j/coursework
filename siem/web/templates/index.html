



<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIEM Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .critical {
            background-color: #721c24;
            color: white;
            border-left: 5px solid #ff0000;
            animation: pulse 2s infinite;
        }

        .high {
            background-color: #dc3545;
            color: white;
        }

        .medium {
            background-color: #fff3cd;
        }

        .low {
            background-color: #d4edda;
        }

        /* Pinned attacks */
        .pinned-attack {
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-weight: bold;
        }

        /* Pulsing animation for critical alerts */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Blocked IP badge */
        .badge-blocked {
            background-color: #dc3545;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 5px;
        }

        /* Loading indicator */
        #loading {
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <header>
        <h1>üëÅÔ∏è –ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π | {{ current_user.email }}</h1>
        <p>–û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è: {{ current_user.organization.name }}</p>

        <nav>
            <a href="{{ url_for('views.devices') }}">üì¶ –ü—Ä–∏—Å—Ç—Ä–æ—ó</a>
            {% if current_user.role == 'admin' %}
                <a href="{{ url_for('views.add_user') }}">‚ûï –î–æ–¥–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</a>
                <a href="{{ url_for('views.users') }}">üë• –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</a>
            {% endif %}
            <a href="{{ url_for('views.logout') }}">üö™ –í–∏–π—Ç–∏</a>
        </nav>
    </header>

    <main>
        <div id="loading" style="display: none;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        
        {% if current_user.role == 'admin' %}
            <div class="admin-controls">
                <a href="{{ url_for('views.blocked_ips') }}" class="blocked-ips-link">üö´ –ó–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ IP</a>
                <button id="auto-block-btn" class="btn-danger">üõ°Ô∏è –ê–≤—Ç–æ–±–ª–æ–∫—É–≤–∞–Ω–Ω—è</button>
            </div>
        {% endif %}


        <!-- Add this to your admin controls section -->
        <button id="generate-report-btn" class="btn-report">üìù –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∑–≤—ñ—Ç</button>

        <!-- Add this modal at the bottom of your body -->
        <div id="report-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>–ó–≤—ñ—Ç –ø—Ä–æ –±–µ–∑–ø–µ–∫—É</h2>
                <pre id="report-content"></pre>
                <button id="send-to-telegram">üì§ –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤ Telegram</button>
            </div>
        </div>
        <!-- Pinned Attacks Section -->
        <div id="pinned-attacks">
            <h2>üîí –í–∞–∂–ª–∏–≤—ñ –ø–æ–¥—ñ—ó</h2>
            <table>
                <thead>
                    <tr>
                        <th>–ü—Ä–∏—Å—Ç—Ä—ñ–π</th>
                        <th>–¢–∏–ø –ø–æ–¥—ñ—ó</th>
                        <th>–†—ñ–≤–µ–Ω—å</th>
                        <th>–î–µ—Ç–∞–ª—ñ</th>
                        <th>–ß–∞—Å</th>
                    </tr>
                </thead>
                <tbody id="pinned-logs">
                    <!-- Pinned logs will appear here -->
                </tbody>
            </table>
        </div>

        <!-- All Logs Section -->
        <div id="all-logs">
            <h2>üìú –í—Å—ñ –ø–æ–¥—ñ—ó</h2>
            <table>
                <thead>
                    <tr>
                        <th>–ü—Ä–∏—Å—Ç—Ä—ñ–π</th>
                        <th>–¢–∏–ø –ø–æ–¥—ñ—ó</th>
                        <th>–†—ñ–≤–µ–Ω—å</th>
                        <th>–î–µ—Ç–∞–ª—ñ</th>
                        <th>–ß–∞—Å</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody id="logs-body">
                    <!-- All logs will appear here -->
                </tbody>
            </table>
        </div>
    </main>

    <script>
        // Global variable to store blocked IPs
        let blockedIPs = new Set();

        async function fetchBlockedIPs() {
            try {
                const response = await fetch('/blocked_ips');
                const data = await response.json();
                blockedIPs = new Set(data.map(ip => ip.ip_address));
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏—Ö IP:', error);
            }
        }

        async function fetchLogs() {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
    
            try {
                // Fetch both logs and blocked IPs
                await fetchBlockedIPs();
                const response = await fetch('/logs');
                const logs = await response.json();
                
                const pinnedTbody = document.getElementById('pinned-logs');
                const regularTbody = document.getElementById('logs-body');
                
                pinnedTbody.innerHTML = '';
                regularTbody.innerHTML = '';
    
                logs.forEach(log => {
                    const isAttack = log.event_type.includes('Attack') || 
                                    ['critical', 'high'].includes(log.severity?.toLowerCase());
                    const isBlocked = log.details?.source_ip && blockedIPs.has(log.details.source_ip);
                    
                    const tr = document.createElement('tr');
                    tr.className = log.severity ? log.severity.toLowerCase() : '';
                    if (isAttack) tr.classList.add('attack-row');
                    if (isBlocked) tr.classList.add('blocked-row');
                    
                    const details = log.details ? JSON.stringify(log.details) : '–ù–µ–º–∞—î –¥–µ—Ç–∞–ª–µ–π';
                    const attackActions = isAttack ? `
                        <td>
                            ${!isBlocked ? `<button onclick="blockIP('${log.details?.source_ip}')" class="btn-block">üö´ –ë–ª–æ–∫—É–≤–∞—Ç–∏ IP</button>` : ''}
                        </td>
                    ` : '<td></td>';
                    
                    tr.innerHTML = `
                        <td>${log.device_name || '–ù–µ–≤—ñ–¥–æ–º–∏–π –ø—Ä–∏—Å—Ç—Ä—ñ–π'}</td>
                        <td>${log.event_type}</td>
                        <td>
                            ${log.severity || 'info'}
                            ${isBlocked ? '<span class="badge-blocked">–ë–õ–û–ö</span>' : ''}
                        </td>
                        <td class="log-details">${details}</td>
                        <td>${new Date(log.created_at).toLocaleString()}</td>
                        ${attackActions}
                    `;
                    
                    // Add to pinned if critical/high severity
                    if (['critical', 'high'].includes(log.severity?.toLowerCase())) {
                        tr.classList.add('pinned-attack');
                        pinnedTbody.appendChild(tr.cloneNode(true));
                    }
                    
                    regularTbody.appendChild(tr);
                });
            } catch (error) {
                console.error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ª–æ–≥–∏:', error);
            } finally {
                loading.style.display = 'none';
            }
        }

        async function blockIP(ipAddress) {
            if (!ipAddress) return;
            
            try {
                const response = await fetch(`/block_ip/${ipAddress}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    alert(`IP ${ipAddress} —É—Å–ø—ñ—à–Ω–æ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ`);
                    fetchLogs(); // Refresh logs
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –±–ª–æ–∫—É–≤–∞–Ω–Ω—ñ IP');
                }
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è IP:', error);
            }
        }

        // Initialize and refresh every 5 seconds
        fetchLogs();
        setInterval(fetchLogs, 5000);
        
    </script>
</body>
</html>

