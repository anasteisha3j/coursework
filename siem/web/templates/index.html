<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIEM Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <style>
       
    </style>
</head>
<body>
    <header>
        <h1>üëÅÔ∏è –ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π | {{ current_user.email }}</h1>
        <p>–û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è: {{ current_user.organization.name }}</p>
        <nav>
            <a href="{{ url_for('views.devices') }}">üì¶ –ü—Ä–∏—Å—Ç—Ä–æ—ó</a>
            {% if current_user.role == 'admin' %}
                <a href="{{ url_for('views.add_user') }}">‚ûï –î–æ–¥–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</a>
                <a href="{{ url_for('views.users') }}">üë• –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</a>
            {% endif %}
            <a href="{{ url_for('views.logout') }}">üö™ –í–∏–π—Ç–∏</a>
        </nav>
    </header>

    <main>
        <div id="loading" style="display: none;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

        {% if current_user.role == 'admin' %}
            <div class="admin-controls">
                <a href="{{ url_for('views.blocked_ips') }}" class="blocked-ips-link">üö´ –ó–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ IP</a>
            </div>
        {% endif %}

        <button id="generate-report-btn" class="btn-report">üìù –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∑–≤—ñ—Ç</button>


        <div id="pinned-attacks">
            <h2>üîí –í–∞–∂–ª–∏–≤—ñ –ø–æ–¥—ñ—ó</h2>
            <table>
                <thead>
                    <tr>
                        <th>–ü—Ä–∏—Å—Ç—Ä—ñ–π</th>
                        <th>–¢–∏–ø –ø–æ–¥—ñ—ó</th>
                        <th>–†—ñ–≤–µ–Ω—å</th>
                        <th>–î–µ—Ç–∞–ª—ñ</th>
                        <th>–ß–∞—Å</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody id="pinned-logs">

                </tbody>
            </table>
        </div>

        <div id="all-logs">
            <h2>üìú –í—Å—ñ –ø–æ–¥—ñ—ó</h2>
            <table>
                <thead>
                    <tr>
                        <th>–ü—Ä–∏—Å—Ç—Ä—ñ–π</th>
                        <th>–¢–∏–ø –ø–æ–¥—ñ—ó</th>
                        <th>–†—ñ–≤–µ–Ω—å</th>
                        <th>–î–µ—Ç–∞–ª—ñ</th>
                        <th>–ß–∞—Å</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody id="logs-body">

                </tbody>
            </table>
        </div>
    </main>

    <div id="log-detail-modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>–î–µ—Ç–∞–ª—ñ –ø–æ–¥—ñ—ó</h2>
            <pre id="log-details-content"></pre>
        </div>
    </div>









<script>
document.getElementById('generate-report-btn').addEventListener('click', () => {
    document.getElementById('loading').style.display = 'block';
    
    fetch('/generate_report', {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        alert(data.message || '–ó–≤—ñ—Ç –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –≤ Telegram!');
    })
    .catch(err => {
        alert('–ü–æ–º–∏–ª–∫–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∑–≤—ñ—Ç—É.');
        console.error(err);
    })
    .finally(() => {
        document.getElementById('loading').style.display = 'none';
    });
});
</script>


    
    <script>
        let blockedIPs = new Set(); 
    
        // Fetch blocked IPs
        async function fetchBlockedIPs() {
            try {
                const response = await fetch('/blocked_ips');
                const data = await response.json();
                blockedIPs = new Set(data.map(ip => ip.ip_address));
                renderBlockedIPs(data);
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏—Ö IP:', error);
            }
        }
    
        // Render blocked IPs in the UI
        function renderBlockedIPs(blockedIPsData) {
            const blockedIPsBody = document.getElementById('blocked-ips-body');
            blockedIPsBody.innerHTML = ''; // Clear previous blocked IPs
    
            blockedIPsData.forEach(ipData => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${ipData.ip_address}</td>
                    <td>${new Date(ipData.blocked_at).toLocaleString()}</td>
                `;
                blockedIPsBody.appendChild(row);
            });
        }
    
        // Manually block an IP
        async function blockIP(ipAddress) {
            if (!ipAddress) return;
    
            try {
                const response = await fetch(`/block_ip/${ipAddress}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
    
                if (response.ok) {
                    alert(`IP ${ipAddress} —É—Å–ø—ñ—à–Ω–æ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ`);
                    fetchLogs(); // Refresh logs to reflect any changes
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –±–ª–æ–∫—É–≤–∞–Ω–Ω—ñ IP');
                }
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è IP:', error);
            }
        }
    
        // Auto-blocking function
        // Set up event listener for auto-block button

        // Update logs in the main table
function updateLogsUI(logs) {
    const logsBody = document.getElementById('logs-body');
    logsBody.innerHTML = '';

    logs.forEach(log => {
        const row = document.createElement('tr');
        row.classList.add(log.severity?.toLowerCase());

        const detailsButton = document.createElement('button');
        detailsButton.textContent = '–î–µ—Ç–∞–ª—ñ';
        detailsButton.addEventListener('click', () => openLogDetails(log));

        const blockButton = document.createElement('button');
        blockButton.textContent = '–ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ IP';
        blockButton.classList.add('btn-danger');
        blockButton.addEventListener('click', () => blockIP(log.ip_address));

        row.innerHTML = `
            <td>${log.device_name}</td>
            <td>${log.event_type}</td>
            <td>${log.severity}</td>
            <td></td> <!-- –î–µ—Ç–∞–ª—ñ –∫–Ω–æ–ø–∫–∞ -->
            <td>${new Date(log.created_at).toLocaleString()}</td>
            <td></td> <!-- –ë–ª–æ–∫ –∫–Ω–æ–ø–∫–∞ -->
        `;

        row.children[3].appendChild(detailsButton);
        row.children[5].appendChild(blockButton);

        logsBody.appendChild(row);
    });
}

    
        // Open log details in the modal
        function openLogDetails(log) {
            let formattedDetails;
            try {
                formattedDetails = typeof log.details === 'object'
                    ? JSON.stringify(log.details, null, 2)
                    : log.details;
            } catch {
                formattedDetails = log.details;
            }
    
            const content = `
            –ü—Ä–∏—Å—Ç—Ä—ñ–π: ${log.device_name}
            –¢–∏–ø –ø–æ–¥—ñ—ó: ${log.event_type}
            –†—ñ–≤–µ–Ω—å: ${log.severity}
            –î–µ—Ç–∞–ª—ñ: ${formattedDetails}
            
            –ß–∞—Å: ${new Date(log.created_at).toLocaleString()}
            `;
            document.getElementById('log-details-content').textContent = content;
            document.getElementById('log-detail-modal').style.display = 'block';
        }
    
        // Close modal
        function closeModal() {
            document.getElementById('log-detail-modal').style.display = 'none';
        }
    
        // Render pinned critical logs
        function renderPinnedLogs(logs) {
            const pinnedLogsContainer = document.getElementById('pinned-logs');
            pinnedLogsContainer.innerHTML = '';
    
            const criticalLogs = logs.filter(log => log.severity === 'critical');
    
            criticalLogs.forEach(log => {
                const row = document.createElement('tr');
                row.className = log.severity;
    
                const detailsButton = document.createElement('button');
                detailsButton.textContent = '–î–µ—Ç–∞–ª—ñ';
                detailsButton.addEventListener('click', () => openLogDetails(log));
    
                const blockButton = document.createElement('button');
                blockButton.textContent = '–ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ IP';
                blockButton.classList.add('btn-danger');
                blockButton.addEventListener('click', () => blockIP(log.ip_address));
    
                row.innerHTML = `
                    <td>${log.device_name || '–ù–µ–≤—ñ–¥–æ–º–∏–π –ø—Ä–∏—Å—Ç—Ä—ñ–π'}</td>
                    <td>${log.event_type}</td>
                    <td>${log.severity}</td>
                    <td></td> <!-- Empty for details button -->
                    <td>${new Date(log.created_at).toLocaleString()}</td>
                    <td></td> <!-- Empty for block button -->
                `;
    
                row.querySelector('td:nth-child(4)').appendChild(detailsButton);  // Details button in the 4th column
                row.querySelector('td:last-child').appendChild(blockButton);     // Block IP button in the actions column
    
                pinnedLogsContainer.appendChild(row);
            });
    
            setupPinnedDetailsButtons(); // Reinitialize the event listeners for details buttons
        }
    
    
        // Setup the details buttons for pinned logs
        function setupPinnedDetailsButtons() {
            document.querySelectorAll('.details-btn').forEach(button => {
                button.addEventListener('click', () => {
                    let detailsObj;
                    try {
                        detailsObj = JSON.parse(button.dataset.details);
                    } catch {
                        detailsObj = button.dataset.details;
                    }
    
                    const log = {
                        device_name: button.dataset.device,
                        event_type: button.dataset.type,
                        severity: button.dataset.severity,
                        details: detailsObj,
                        created_at: button.dataset.time
                    };
    
                    openLogDetails(log);
                });
            });
        }
    
        // Fetch logs
        async function fetchLogs() {
            try {
                const response = await fetch('/logs');
                const logs = await response.json();
                updateLogsUI(logs); // Update UI with new logs
                renderPinnedLogs(logs); // Render pinned logs
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –ª–æ–≥—ñ–≤:', error);
            }
        }
    
        // Fetch logs and blocked IPs when the page loads
        fetchLogs();
        fetchBlockedIPs();
        setInterval(fetchLogs, 5000); // Refresh logs every 5 seconds
    </script>




</body>
</html>
    
