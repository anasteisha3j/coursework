<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIEM Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <style>
       
    </style>
</head>
<body>
    <header>
        <h1>üëÅÔ∏è –ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π | {{ current_user.email }}</h1>
        <p>–û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è: {{ current_user.organization.name }}</p>
        <nav>
            <a href="{{ url_for('views.devices') }}">üì¶ –ü—Ä–∏—Å—Ç—Ä–æ—ó</a>
            {% if current_user.role == 'admin' %}
                <a href="{{ url_for('views.add_user') }}">‚ûï –î–æ–¥–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</a>
                <a href="{{ url_for('views.users') }}">üë• –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</a>
            {% endif %}
            <a href="{{ url_for('views.logout') }}">üö™ –í–∏–π—Ç–∏</a>
        </nav>
    </header>

    <main>
        <div id="loading" style="display: none;" >–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

        {% if current_user.role == 'admin' %}
            <div class="admin-controls">
                <a href="{{ url_for('views.blocked_ips') }}" class="blocked-ips-link">üö´ –ó–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ IP</a>
            </div>
        {% endif %}

        <button id="generate-report-btn" class="btn-report">–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∑–≤—ñ—Ç</button>


        


 


        <div class="report-period">
            <h3>–ü–µ—Ä—ñ–æ–¥ –¥–ª—è –∑–≤—ñ—Ç—É:</h3>
            <form id="report-period-form">
                <label for="report-start-date">–ó:</label>
                <input type="date" id="report-start-date" name="start_date" required>
                
                <label for="report-end-date">–ü–æ:</label>
                <input type="date" id="report-end-date" name="end_date" required>
            </form>
        </div>


            <table>
                <thead>
                    <tr>
                        <th>–ü—Ä–∏—Å—Ç—Ä—ñ–π</th>
                        <th>–¢–∏–ø –ø–æ–¥—ñ—ó</th>
                        <th>–†—ñ–≤–µ–Ω—å</th>
                        <th>–î–µ—Ç–∞–ª—ñ</th>
                        <th>–ß–∞—Å</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody id="pinned-logs">

                </tbody>
            </table>
        </div>

        <div id="all-logs">
            <h2>üìú –í—Å—ñ –ø–æ–¥—ñ—ó</h2>
            
            <table>
                <thead>
                    <tr>
                        <th>–ü—Ä–∏—Å—Ç—Ä—ñ–π</th>
                        <th>–¢–∏–ø –ø–æ–¥—ñ—ó</th>
                        <th>–†—ñ–≤–µ–Ω—å</th>
                        <th>–î–µ—Ç–∞–ª—ñ</th>
                        <th>–ß–∞—Å</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody id="logs-body">
                    {% if logs %}
                        {% for log in logs %}
                        <tr class="{{ log.severity|lower }}">
                            <td>{{ log.device_name }}</td>
                            <td>{{ log.event_type }}</td>
                            <td>{{ log.severity }}</td>
                            <td>
                                <button onclick="openLogDetails({{ log|tojson }})">–î–µ—Ç–∞–ª—ñ</button>
                            </td>
                            <td>{{ log.created_at }}</td>                            <td>
                                <button class="btn-danger" onclick="blockIP('{{ log.ip_address }}')">–ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ IP</button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6">–ü–æ–¥—ñ–π –∑–∞ —Ü–µ–π –¥–µ–Ω—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</td>
                        </tr>
                    {% endif %}
                </tbody>
                
            </table>
        </div>
    </main>

    <div id="log-detail-modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>–î–µ—Ç–∞–ª—ñ –ø–æ–¥—ñ—ó</h2>
            <pre id="log-details-content"></pre>
        </div>
    </div>









    <script>
        let blockedIPs = new Set(); 
    
        async function fetchBlockedIPs() {
            try {
                const response = await fetch('/blocked_ips');
                const data = await response.json();
                blockedIPs = new Set(data.map(ip => ip.ip_address));
                renderBlockedIPs(data);
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏—Ö IP:', error);
            }
        }
    
        function renderBlockedIPs(blockedIPsData) {
            const blockedIPsBody = document.getElementById('blocked-ips-body');
            if (!blockedIPsBody) return;
    
            blockedIPsBody.innerHTML = ''; 
    
            blockedIPsData.forEach(ipData => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${ipData.ip_address}</td>
                    <td>${new Date(ipData.blocked_at).toLocaleString()}</td>
                `;
                blockedIPsBody.appendChild(row);
            });
        }
    
        // Manually block an IP
        async function blockIP(ipAddress) {
            if (!ipAddress) return;
            console.log('Blocking IP:', ipAddress);  
    
            try {
                const response = await fetch(`/block_ip/${ipAddress}`, {
                    method: 'POST'
                });
    
                const result = await response.json();
                alert(result.message || 'IP –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ');
    
                if (response.ok) {
                    fetchLogs();       
                    fetchBlockedIPs(); 
                }
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è IP:', error);
            }
        }
    
        function updateLogsUI(logs) {
            const logsBody = document.getElementById('logs-body');
            if (!logsBody) return;
        
            logsBody.innerHTML = '';
        
            logs.forEach(log => {
                const row = document.createElement('tr');
                row.classList.add(log.severity?.toLowerCase());
        
                const detailsButton = document.createElement('button');
                detailsButton.textContent = '–î–µ—Ç–∞–ª—ñ';
                detailsButton.addEventListener('click', () => openLogDetails(log));
        
                const blockButton = document.createElement('button');
                blockButton.textContent = '–ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ IP';
                blockButton.classList.add('btn-danger');
                blockButton.addEventListener('click', () => blockIP(log.ip_address));
        
                row.innerHTML = `
                    <td>${log.device_name || '–ù–µ–≤—ñ–¥–æ–º–∏–π –ø—Ä–∏—Å—Ç—Ä—ñ–π'}</td>
                    <td>${log.event_type}</td>
                    <td>${log.severity}</td>
                    <td></td>
                    <td>${new Date(log.created_at).toLocaleString()}</td>
                    <td></td>
                `;
        
                row.children[3].appendChild(detailsButton);
                row.children[5].appendChild(blockButton);
        
                logsBody.appendChild(row);
            });
        }
        function openLogDetails(log) {
            let formattedDetails;
            try {
                formattedDetails = typeof log.details === 'object'
                    ? JSON.stringify(log.details, null, 2)
                    : log.details;
            } catch {
                formattedDetails = log.details;
            }
        
            const content = `
        –ü—Ä–∏—Å—Ç—Ä—ñ–π: ${log.device_name || '–ù–µ–≤—ñ–¥–æ–º–∏–π –ø—Ä–∏—Å—Ç—Ä—ñ–π'}
        –¢–∏–ø –ø–æ–¥—ñ—ó: ${log.event_type}
        –†—ñ–≤–µ–Ω—å: ${log.severity}
        –î–µ—Ç–∞–ª—ñ: ${formattedDetails}
        
        –ß–∞—Å: ${new Date(log.created_at).toLocaleString()}
            `;
            document.getElementById('log-details-content').textContent = content;
            document.getElementById('log-detail-modal').style.display = 'block';
        }
    
        function closeModal() {
            document.getElementById('log-detail-modal').style.display = 'none';
        }
    
        function renderPinnedLogs(logs) {
            const pinnedLogsContainer = document.getElementById('pinned-logs');
            if (!pinnedLogsContainer) return;
        
            pinnedLogsContainer.innerHTML = '';
        
            const today = new Date();
            today.setHours(0, 0, 0, 0); // –ø–æ—á–∞—Ç–æ–∫ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –¥–Ω—è
        
            const criticalLogs = logs.filter(log => {
                if (log.severity !== 'critical') return false;
        
                const logDate = new Date(log.created_at);
                logDate.setHours(0, 0, 0, 0); // –Ω—É–ª—å–æ–≤–∞ –≥–æ–¥–∏–Ω–∞ –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –¥–∞—Ç–∏
        
                return logDate.getTime() === today.getTime();
            });
        
            if (criticalLogs.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6">–ù–µ–º–∞—î –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –ø–æ–¥—ñ–π –∑–∞ —Å—å–æ–≥–æ–¥–Ω—ñ.</td>`;
                pinnedLogsContainer.appendChild(row);
                return;
            }
        
            criticalLogs.forEach(log => {
                const row = document.createElement('tr');
                row.className = log.severity.toLowerCase();
        
                const detailsButton = document.createElement('button');
                detailsButton.textContent = '–î–µ—Ç–∞–ª—ñ';
                detailsButton.addEventListener('click', () => openLogDetails(log));
        
                const blockButton = document.createElement('button');
                blockButton.textContent = '–ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ IP';
                blockButton.classList.add('btn-danger');
                blockButton.addEventListener('click', () => blockIP(log.ip_address));
        
                row.innerHTML = `
                    <td>${log.device_name || '–ù–µ–≤—ñ–¥–æ–º–∏–π –ø—Ä–∏—Å—Ç—Ä—ñ–π'}</td>
                    <td>${log.event_type}</td>
                    <td>${log.severity}</td>
                    <td></td>
                    <td>${new Date(log.created_at).toLocaleString()}</td>
                    <td></td>
                `;
        
                row.querySelector('td:nth-child(4)').appendChild(detailsButton);
                row.querySelector('td:last-child').appendChild(blockButton);
        
                pinnedLogsContainer.appendChild(row);
            });
        }
        
        
    
        async function fetchLogs() {
            try {
                const response = await fetch('/logs');
                const logs = await response.json();
                updateLogsUI(logs);
                renderPinnedLogs(logs);
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –ª–æ–≥—ñ–≤:', error);
            }
        }
    
        fetchLogs();
        fetchBlockedIPs();
        setInterval(fetchLogs, 5000);
    
        document.getElementById('generate-report-btn').addEventListener('click', async () => {
            const loadingElement = document.getElementById('loading');
            loadingElement.style.display = 'block';
            
            try {
                const startDate = document.getElementById('report-start-date').value;
                const endDate = document.getElementById('report-end-date').value;
                
                if (!startDate || !endDate) {
                    alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∫–∞–∂—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥ –¥–ª—è –∑–≤—ñ—Ç—É');
                    return;
                }
                
                const response = await fetch('/generate_report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        start_date: startDate,
                        end_date: endDate
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    alert(data.message || '–ó–≤—ñ—Ç —É—Å–ø—ñ—à–Ω–æ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ —Ç–∞ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ');
                } else {
                    throw new Error(data.error || '–ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∑–≤—ñ—Ç—É');
                }
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
                console.error('–ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∑–≤—ñ—Ç—É:', error);
            } finally {
                loadingElement.style.display = 'none';
            }
        });
        
    </script>
    








</body>
</html>
    